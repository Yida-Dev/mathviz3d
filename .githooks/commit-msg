#!/bin/bash
# Commit-msg hook: 强制英文 commit message（检查非 ASCII）

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# 跳过 merge commits
if echo "$COMMIT_MSG" | head -1 | grep -qE '^Merge'; then
    exit 0
fi

# 检查是否包含中文字符（排除 Co-Authored-By 行）
CHINESE=$(echo "$COMMIT_MSG" | grep -v "Co-Authored-By" | perl -CSD -ne 'print if /[\x{4e00}-\x{9fff}]/')

if [ -n "$CHINESE" ]; then
    echo "Error: Commit message must be in English (no Chinese characters)"
    echo "Found Chinese characters:"
    echo "$CHINESE"
    exit 1
fi

# 检查 Conventional Commits 格式
FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)
if ! echo "$FIRST_LINE" | grep -qE '^(feat|fix|refactor|docs|test|chore|style|perf|ci|build|revert)(\(.+\))?: .+'; then
    echo "Error: Commit message must follow Conventional Commits format"
    echo "Examples: feat: add login, fix(auth): resolve token issue"
    exit 1
fi

exit 0
